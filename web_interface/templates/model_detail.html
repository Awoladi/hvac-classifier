{% extends "base.html" %}

{% block content %}
<div class="model-card">
    <div class="model-header">
        <div class="model-info">
            <div class="model-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="model-details">
                <h3>{{ model.filename }}</h3>
                <p>Hochgeladen am {{ model.uploaded_at.strftime('%d.%m.%Y') }} • {{ components|length }} Komponenten</p>
            </div>
        </div>
        <div>
            <a href="#" class="btn btn-light me-2" id="exportButton">
                <i class="fas fa-download btn-icon"></i> Export
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-primary">
                <i class="fas fa-arrow-left btn-icon"></i> Zurück zur Übersicht
            </a>
        </div>
    </div>
    
    <!-- Search and Filters -->
    <div class="search-section">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Nach Komponenten suchen...">
        </div>
        <div class="filter-container">
            <select class="filter-select" data-filter="ifc_class">
                <option value="all" selected>Alle IFC-Klassen</option>
                {% set ifc_classes = [] %}
                {% for component in components %}
                    {% if component.ifc_class not in ifc_classes %}
                        {% set ifc_classes = ifc_classes + [component.ifc_class] %}
                        <option value="{{ component.ifc_class }}">{{ component.ifc_class }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <select class="filter-select" data-filter="system">
                <option value="all" selected>Alle Systeme</option>
                {% for system in systems %}
                    <option value="{{ system.id }}">{{ system.name }}</option>
                {% endfor %}
            </select>
            <select class="filter-select" data-filter="electronic">
                <option value="all" selected>Elektronisch/Nicht elektronisch</option>
                <option value="true">Nur elektronisch</option>
                <option value="false">Nur nicht elektronisch</option>
            </select>
        </div>
    </div>
</div>

<!-- Components Table -->
<div class="components-table">
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 60px;">#</th>
                <th style="width: 150px;">GlobalId</th>
                <th>Name</th>
                <th>Klasse</th>
                <th>Standort</th>
                <th>Elektronisch</th>
                <th>BAS-Code</th>
                <th style="width: 100px;">Aktion</th>
            </tr>
        </thead>
        <tbody>
            {% for component in components %}
            <tr>
                <td>{{ loop.index }}</td>
                <td><span class="component-id">{{ component.global_id[:8] }}...</span></td>
                <td><span class="component-name">{{ component.name }}</span></td>
                <td data-ifc_class="{{ component.ifc_class }}">
                    <span class="badge badge-ifc">{{ component.ifc_class }}</span>
                </td>
                <td>
                    {% if component.location %}
                        <span class="badge badge-location">
                            {{ component.location.storey_name }}
                            {% if component.location.space_name %}
                                / {{ component.location.space_name }}
                            {% endif %}
                        </span>
                    {% else %}
                        <span class="badge badge-secondary">Unbekannt</span>
                    {% endif %}
                </td>
                <td data-electronic="{{ component.is_electronic|string|lower }}">
                    <span class="badge {{ 'badge-electronic' if component.is_electronic else 'badge-non-electronic' }}">
                        {{ 'Ja' if component.is_electronic else 'Nein' }}
                    </span>
                </td>
                <td>
                    <span class="badge badge-bas">{{ component.bas_code }}</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-light btn-table btn-details" data-component-id="{{ component.id }}">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination-container">
    <span class="page-info">Zeige {{ components|length }} von {{ components|length }} Komponenten</span>
    {% if components|length > 10 %}
    <div class="pagination">
        <button class="page-btn" disabled>
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="page-btn active">1</button>
        <button class="page-btn">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    {% endif %}
</div>

<!-- Component Modal -->
<div class="modal fade" id="componentModal" tabindex="-1" aria-labelledby="componentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="componentModalLabel">
                    <i class="fas fa-info-circle me-2"></i> Komponenten-Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h6 class="modal-section-title">
                        <i class="fas fa-id-card section-icon"></i> Allgemeine Informationen
                    </h6>
                    <table class="info-table">
                        <tbody>
                            <tr>
                                <th>ID:</th>
                                <td id="component-id"></td>
                            </tr>
                            <tr>
                                <th>GlobalId:</th>
                                <td id="component-global-id"></td>
                            </tr>
                            <tr>
                                <th>Name:</th>
                                <td id="component-name"></td>
                            </tr>
                            <tr>
                                <th>IFC-Klasse:</th>
                                <td id="component-class"></td>
                            </tr>
                            <tr>
                                <th>Elektronisch gesteuert:</th>
                                <td><span id="component-electronic" class="badge"></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="modal-section">
                    <h6 class="modal-section-title">
                        <i class="fas fa-tag section-icon"></i> BAS-Informationen
                    </h6>
                    <table class="info-table">
                        <tbody>
                            <tr>
                                <th>BAS-Code:</th>
                                <td id="component-bas-code"></td>
                            </tr>
                            <tr>
                                <th>BAS-Standard:</th>
                                <td id="component-bas-standard"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="modal-section">
                    <h6 class="modal-section-title">
                        <i class="fas fa-map-marker-alt section-icon"></i> Standort
                    </h6>
                    <div id="location-info" class="p-3 bg-light rounded"></div>
                </div>
                
                <div class="modal-section">
                    <h6 class="modal-section-title">
                        <i class="fas fa-list-ul section-icon"></i> Eigenschaften
                    </h6>
                    <div id="properties-container"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="fas fa-download me-2"></i> Daten exportieren
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exportFormat" class="form-label">Format auswählen</label>
                    <select class="form-select" id="exportFormat">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="xlsx">Excel (XLSX)</option>
                    </select>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="includeProperties" checked>
                    <label class="form-check-label" for="includeProperties">Eigenschaften einbeziehen</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="includeLocation" checked>
                    <label class="form-check-label" for="includeLocation">Standortinformationen einbeziehen</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="currentFilter">
                    <label class="form-check-label" for="currentFilter">Nur aktuell gefilterte Komponenten</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" id="downloadButton">
                    <i class="fas fa-download me-2"></i> Herunterladen
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Export-Button-Funktionalität
    const exportButton = document.getElementById('exportButton');
    if (exportButton) {
        exportButton.addEventListener('click', function(e) {
            e.preventDefault();
            const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
            exportModal.show();
        });
    }
    
    // Download-Button-Funktionalität
    const downloadButton = document.getElementById('downloadButton');
    if (downloadButton) {
        downloadButton.addEventListener('click', function() {
            const format = document.getElementById('exportFormat').value;
            const includeProps = document.getElementById('includeProperties').checked;
            const includeLoc = document.getElementById('includeLocation').checked;
            const currentFilter = document.getElementById('currentFilter').checked;
            
            // Erstelle Query-Parameter
            const params = new URLSearchParams({
                format: format,
                properties: includeProps,
                location: includeLoc,
                filtered: currentFilter
            });
            
            // Exportiere die Daten
            window.location.href = `{{ url_for('export_model_data', model_id=model.id) }}?${params.toString()}`;
            
            // Schließe das Modal
            bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
        });
    }
});
</script>
{% endblock %}